<html>
    <head>
        <title>The Human Machine Language</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- page styling -->
        <link rel="stylesheet" href="css/hml.css" />
        
        <!-- bootstrap and jquery -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> 
        
        <!-- polyfill -->
        <script src="js/url-search-parms.js"></script>
    </head>
    <body>
        <a href="https://github.com/PerryHighCS/HML" class="github-corner" aria-label="View source on Github" draggable="false">
            <svg width="50" height="50" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
                <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                      fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body">
                </path>
            </svg>
        </a>
        <!-- The main toolbar -->
        <div class="toolbox">
            
            <!-- tabs for program code and running the program -->
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#inst" draggable="false">Program It</a></li>
                <li class="tryIt">
                    <a class="tabButtons" data-toggle="tab" href="#run" draggable="false">Try It</a>
                    <!-- buttons appear to run the code when Try-it is selected -->
                    <div class="tabButtons">
                        &nbsp;
                        <button class="btn btn-success runbtn" onclick="runIt()">
                            <span class="glyphicon glyphicon-play-circle"></span>&nbsp;Run Program
                        </button>
                        <button class="btn btn-danger stopbtn" onclick="stopIt()">
                            <span class="glyphicon glyphicon-remove-circle"></span>&nbsp;Stop Program
                        </button>
                        
                        <div class="btn-group tabButtons">
                            <button type="button" class="btn btn-success redealbtn" onclick="if(!$(this).hasClass('disabled')){deal();}">
                                    Redeal Cards
                            </button>
                            <button type="button" class="btn btn-success dropdown-toggle redealbtn" data-toggle="dropdown" >
                                   &#8239;<span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li onclick="deal(5)"><a>5 cards</a></li>
                                <li onclick="deal(8);"><a>8 cards</a></li>
                                <li onclick="deal(10);"><a>10 cards</a></li>
                                <li onclick="deal(12);"><a>12 cards</a></li>
                                <li onclick="deal(15);"><a>15 cards</a></li>
                                <li onclick="deal(20);"><a>20 cards</a></li>
                            </ul>
                        </div>
                        Run Speed:&nbsp;
                        <input type="range" class="slider" id="runSlider" min="0" max="100" step="1" value="50" onchange="setURLSpeed(this.value)"/>
                        &nbsp;<span class="glyphicon glyphicon-flash"></span>
                        &nbsp;Steps:&nbsp;<span class="stepCount"></span>
                    </div>
                    </li>
            </ul>
            <div class="tab-content">
                <!-- the programming tab -->
                <div id="inst" class="tab-pane fade in active">
                    <div id="directions">
                        <h1>The Human Machine Language</h1>                      
                    </div>
                    
                    <!-- All of the HML commands available -->
                    <div class="commands" 
                         ondrop="trashInstruction(event)" 
                         ondragover="allowDropInstruction(event)" >
                        <b>Command Toolbox:</b>
                        <img src="trash.png" id="trashcan" draggable="false"
                             ondblclick="deleteCode()" alt="trash can">
                        <div class="palette">
                            
                            <!-- the SHIFT HAND instruction -->
                            <div class="instruction shift" draggable="true" ondragstart="dragInstruction(event)" >
                                SHIFT 
                                <div class="fillin hand dropdown">
                                    <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Hand<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                      <li><a href="#">Right Hand</a></li>
                                      <li><a href="#">Left Hand</a></li>
                                    </ul>
                                </div>
                                TO THE 
                                <div class="fillin dir dropdown">
                                    <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Direction<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                      <li><a href="#">Right</a></li>
                                      <li><a href="#">Left</a></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- the MOVE HAND instruction -->
                            <div class="instruction move" draggable="true" ondragstart="dragInstruction(event)">
                                MOVE 
                                <div class="fillin hand dropdown">
                                    <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Hand<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                      <li><a href="#">Right Hand</a></li>
                                      <li><a href="#">Left Hand</a></li>
                                    </ul>
                                </div>
                                TO POSITION 
                                <div class="fillin pos dropdown">
                                    <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Position<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <!-- Positions filled dynamically -->
                                    </ul>
                                </div>
                            </div>

                            <!-- the JUMP TO LINE instruction -->
                            <div class="instruction jump" draggable="true" ondragstart="dragInstruction(event)">
                                JUMP TO LINE
                                <div class="fillin linenum dropdown">
                                    <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Line #<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                      <li><a href="#">1</a></li>
                                    </ul>
                                </div>
                            </div>

                            <!-- the JUMP-IF instruction -->
                            <div class="instruction jumpif" draggable="true" ondragstart="dragInstruction(event)">
                                JUMP TO LINE
                                <div class="fillin linenum dropdown">
                                    <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Line #<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <li><a href="#">1</a></li>
                                    </ul>
                                </div>
                                IF
                                <div class="condition">
                                    &nbsp;
                                    <div class="fillin value dropdown">
                                        <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Value<span class="caret"></span></a>
                                        <ul class="dropdown-menu">
                                            <li><a href="#">Right Hand Card</a></li>
                                            <li><a href="#">Left Hand Card</a></li>
                                            <li><a href="#">Right Hand Position</a></li>
                                            <li><a href="#">Left Hand Position</a></li>
                                        </ul>
                                    </div>
                                    
                                    <div class="fillin comparison dropdown">
                                        <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            compare<span class="caret"></span></a>
                                        <ul class="dropdown-menu">
                                            <li><a href="#">&gt;</a></li>
                                            <li><a href="#">&lt;</a></li>
                                            <li><a href="#">=</a></li> 
                                            <li><a href="#">&ne;</a></li> 
                                            <li><a href="#">&le;</a></li>
                                            <li><a href="#">&ge;</a></li>  
                                        </ul>
                                    </div>
                                     
                                    <div class="fillin value fulllist dropdown">
                                        <a class="dropdown-toggle dropdown-text" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Value<span class="caret"></span></a>
                                        <ul class="dropdown-menu">
                                            <!-- Menu filled dynamically -->
                                        </ul>
                                    </div>
                                    &nbsp;
                                </div>
                            </div>
                            
                            <!-- the SWAP instruction -->
                            <div class="instruction swap" draggable="true" ondragstart="dragInstruction(event)">
                                SWAP
                            </div>
                            
                            <!-- the STOP instruction -->
                            <div class="instruction stop" draggable="true" ondragstart="dragInstruction(event)">
                                STOP
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- The table where cards are dealt when the program is run -->
                <div id="run" class="tab-pane fade">
                    <table id="cardboard" class="table">                        
                        <!-- Card table built dynamically -->
                    </table>
                </div>
            </div>
        </div>
            
        <!-- below the toolbox is the program listing -->
        <div class="wrapper">       
            <div class="programEditor">                
                <table class="table table-hover" id="program">
                    <thead>                        
                        <tr>
                            <th class="linenumcell">Line #</th>
                            <th>Instruction 
                                <div class="copybutton"  onclick="copyInstructions()">
                                    <div class="glyphicon glyphicon-copy"></div>
                                    &nbsp;Copy code to clipboard
                                </div>
                            </th>
                        </tr>                
                    </thead>
                    <tbody>
                        <!-- Program code table built dynamically -->
                    </tbody>
                </table>

            </div>
        </div>
        
        <!-- globals and setup on load -->
        <script>
            // The html for a blank program line
            var instRow = "<tr><td class='linenumcell'>" + 
                            "</td><td class='instructioncell' " + 
                            "ondrop='dropInstruction(event)' " +
                            "ondragover='allowDropInstruction(event)'>" + 
                            "</td></tr>";
            
            // The html for the drop-down caret
            var caret = '<span class="caret"></span>';
                        
            // The url symbols for 21 card values
            var cardValString = 'xa234567890jqkbcdefghi';
            
            window.onload = function() {
                // Hide the stop button, prepare to run code
                stopIt();
                
                let params = new URLSearchParams(window.location.search);

                // unlock the swap instruction if asked nicely
                if (params.has('swap')) {
                    $('.instruction.swap').show();
                }
                else {
                    $('.instruction.swap').hide();
                }

                if (params.has('code')) {
                    buildProgram(params.get('code'));
                }
                
                if (params.has('cards')) {
                    deal(params.get('cards'));
                } 
                else {
                    deal();
                }
                if (params.has('speed')) {
                    document.getElementById("runSlider").value = params.get('speed');
                }
               
                
                // Prepare the code display
                compactLines();
                setLineNumbers();
                fillPositionDropdowns();
                addDropdownHandlers(); 
            };
            
                    
        </script>
        <!-- Drag/Drop interface -->
        <script>
            /**
             * Allow an instruction to be dropped on this element
             * 
             * @param {DropEvent} ev
             */
            function allowDropInstruction(ev) {
                ev.preventDefault();
            }

            /** 
             * Handle an instruction being dragged
             * 
             * @param {DragEvent} ev
             */
            function dragInstruction(ev) {
                let item = $(ev.target);
                
                if (!(item.is(".instruction"))) {
                    item = item.parents(".instruction");
                }
                
                let source = "instructionBank";
                let lineno = -1;
                
                if (item.parents("#program").length > 0) {                    
                    source = "program";                    
                    lineno = $(item.parents("tbody")).find("tr").index(item.parents("tr")) + 1;
                }
                
                let dragItem = {
                                thing: "instruction",
                                src: source,
                                line: lineno,
                                item: item.clone(true, true)[0].outerHTML
                               };
                        
                ev.dataTransfer.setData("text", JSON.stringify(dragItem));
            }

            /**
             * Handle an instruction being dropped into the program
             * 
             * @param {DropEvent} ev
             */
            function dropInstruction(ev) {
                ev.preventDefault();
                
                // Get the item being dropped
                let data = JSON.parse(ev.dataTransfer.getData("text"));
                
                if (data.thing !== "instruction") {
                    return;
                }
                
                // and the place it was dropped
                let target = $(ev.target);
                
                if (!(target.is('td'))) {
                    // If the drop location was not a table cell

                    // Find the parent table cell
                    target = target.parents("td");
                }
                
                // If dragging from the program and the ctrl or shift Key wasn't pressed
                if (data.src === "program" && !(ev.ctrlKey === true || ev.shiftKey === true)) {
                    // delete the original instruction
                    $($("#program tbody tr")[data.line - 1]).find(".instructioncell").empty();
                }
                
                // If the target is currently empty
                if (target.has('.instruction').length === 0 ){
                    // add the instruction to the target
                    target.append(data.item);
                }
                else {
                    // If there was an instruction where the new one was dropped
                    // Insert a new row

                    let curRow = target.parents("tr");

                    curRow.before(instRow);

                    let newRow = curRow.parents("tbody").find("tr").index(curRow) - 1;

                    $(curRow.parent("tbody").find("tr")[newRow]).find(".instructioncell").append(data.item);

                    fixJumps(newRow + 1, 1);
                }  
                
                // Update the program display
                compactLines();
                setLineNumbers();
                fillPositionDropdowns();
                addDropdownHandlers(); 
                setURLCode();
            }
            
            /**
             * Handle an instruction being dropped outside the program editor
             * 
             * @param {DropEvent} ev
             */
            function trashInstruction(ev) {
                ev.preventDefault();
                
                // Get the item being dropped
                let data = JSON.parse(ev.dataTransfer.getData("text"));
                
                if (data.thing !== "instruction") {
                    return;
                }
                
                // and the place it was dropped
                let target = $(ev.target);
                                
                // If dragging from the program
                if (data.src === "program") {
                    // delete the original instruction
                    $($("#program tbody tr")[data.line - 1]).find(".instructioncell").empty();
                }
                                
                // Update the program display
                compactLines();
                setLineNumbers();
                fillPositionDropdowns();
                addDropdownHandlers(); 
                setURLCode();
            }
            
            /** 
             * Handle an card being dragged
             * 
             * @param {DragEvent} ev
             */
            function dragCard(ev) {
                let item = $(ev.target);
                
                let pos = $(item.parents("tr")).find("td").index(item.parents("td"));
                
                
                let dragItem = {
                                thing: "card",
                                item: item.attr('value'),
                                pos: pos
                               };
                
                let text = JSON.stringify(dragItem);
                ev.dataTransfer.setData("text", text);                
            }
            /**
             * Handle an instruction being dropped onto another element
             * @param {DropEvent} ev
             */
            function dropCard(ev) {
                // Get the item being dropped
                let source = JSON.parse(ev.dataTransfer.getData("text"));
                
                // and the place it was dropped
                let target = $(ev.target);
                
                // If the thing being dropped isn't a card
                if (typeof(source.thing) === 'undefined' || 
                        source.thing !== "card") {
                    // It can't be dropped here
                    return;
                }
                
                // Allow the card to be dropped
                ev.preventDefault();
                
                // If the card was droped on another card
                if (!target.is('td')) {
                    // Find the parent table cell
                    target = target.parents("td");
                }
                
                // Find the position of the target
                let targetpos = $(target.parents("tr")).find("td").index(target);
                
                // calculate the direction from target to source
                let dir = -1;                
                if (targetpos > source.pos) {
                    dir = 1;
                }
                
                // Get the list of card cells
                let cardcells = target.siblings().addBack();
                
                // Get the source cell and its card
                let sourceCell = $(cardcells[source.pos]);
                let sourceCard = sourceCell.find('.cardItem');
                
                // Pull the source card out of its cell
                sourceCard.detach();
                let tCell = sourceCell;
                
                // Loop from the source to the target, moving cards over
                for (let i = source.pos; i !== targetpos; i = i + dir) {
                    let cell = $(cardcells[i + dir]);
                    let card = cell.find('.cardItem');
                    card.detach();
                    
                    tCell.append(card);
                    tCell = cell;
                }
                
                // Put the source card into the target position
                $(target).append(sourceCard);  
                
                // Update the url with the cards in place
                setURLCards();
            }
            
            /**
             * Allow a card to be dropped in this location
             * 
             * @param {DragEvent} ev
             */
            function allowCardDrop(ev) {
                ev.preventDefault();
            }
            
            /**
             * Adjust all jumps from a given linenumber to the end of the program
             * so that their target line numbers have a delta added to them to
             * account for, ie inserted or removed lines of code.
             * 
             * @param {Number} changeLine the line number to start adjustments
             *    around
             * 
             * @param {Number} delta the direction and amount to adjust jump
             *  target line numbers
             */
            function fixJumps(changeLine, delta) {
                // Find all lines in the program
                let lines = $("#program tbody tr");                
                
                // loop through all of the lines
                for (let i = 0; i < lines.length; i++) {
                    // if this line is a jump instruction
                    $(lines[i]).find('.jump, .jumpif').each( function() {
                        // Find the linenum of the jump target
                        $(this).find('.fillin.linenum .dropdown-text').each( function() {
                            let oldnum = parseInt($(this).text());
                            
                            // replace the linenum
                            if (!isNaN(oldnum) && oldnum >= changeLine) {
                                $(this).html((oldnum + delta) + caret);
                            }
                        });
                        
                    });
                }
            }
            
            /**
             * Remove all blank lines in the program, and add one blank line at
             * the end of the program.
             */
            function compactLines() {
                // Look at every program line
                $("#program tbody tr").each( function() {
                    // If this line doesn't have an instruction
                    if ($(this).find(".instruction").length === 0) {
                        // Get its line number
                        let lineno = parseInt($(this).find('.linenumcell').text());
                        
                        // Fix jumps to every line after this one
                        fixJumps(lineno + 1, -1);
                        
                        // Remove this blank line
                        $(this).remove();
                    }
                });
                                     
                $("#program tbody").append(instRow);
            }
            
            /**
             * Add click handlers to all dropdown items that replace the text in
             * the dropdown with the selection
             */
            function addDropdownHandlers() {
                // Find all dropdown items, set their click function
                $("#program .dropdown-menu li a").click(function(){
                    // when an item is clicked, find the dropdown-text
                    $(this).parents(".dropdown").find('.dropdown-text')
                            // and fill it with the selected item
                            .html($(this).text() + caret);
                    // then update the URL
                    setURLCode();
                });                
            }
            
            /**
             * Set the available line numbers in all line number dropdowns and 
             * on all program lines
             */
            function setLineNumbers() {
                // Find the number of program lines
                let numLines = $("#program tbody tr").length;
            
                // For every linenum list item in the program
                $(".linenum ul").each(function() {
                    // Clear out all existing line numbers in the list
                    $(this).empty();

                    // Add new linenumbers into the list
                    for (let i = 1; i <= numLines; i++) {
                        $(this).append("<li><a href='#'>" + i + "</a></li>");
                    }
                });
                
                // For every linenumber cell in the program
                $("tbody .linenumcell").each(function() {
                    // Set the linenumber of the line
                    $(this).html($(this).parents("tbody").find("tr").index($(this).parent("tr")) + 1);
                });
            }
            
            /**
             * Fill the value and position dropdowns
             */
            function fillPositionDropdowns() {
                let movePosHTML = "<li><a href='#'>Right Hand Position</a></li>\n\
                                   <li><a href='#'>Left Hand Position</a></li>\n\
                                   <li><a href='#'>Min Position</a></li>\n\
                                   <li><a href='#'>Max Position</a></li>\n\
                                   <li class='divider'></li>";
        
                let itemStart = "<li><a href='#'>";
                let itemEnd = "</a></li>";
                
                let jumpValHTML = "<li><a href='#'>Right Hand Card</a></li>\n\
                                   <li><a href='#'>Left Hand Card</a></li>\n\
                                   <li><a href='#'>Right Hand Position</a></li>\n\
                                   <li><a href='#'>Left Hand Position</a></li>\n\
                                   <li><a href='#'>Min Position</a></li>\n\
                                   <li><a href='#'>Max Position</a></li>\n\
                                   <li class='divider'></li>";
                
                // Build move position menu - include all possible positions
                for (let i = 0; i < runState.numCards; i++) {
                    let movePosValItem = itemStart + i + itemEnd;
                    movePosHTML += movePosValItem;                    
                }
                
                let movePosMenu = $(movePosHTML);
                let moveMenus = $('.fillin.pos ul.dropdown-menu');
                moveMenus.empty();
                moveMenus.append(movePosMenu);
                
                // Fill jump-if positions/values
                for (let i = 0; i <= runState.maxCard; i++) {
                    let jumpItem = itemStart + i + itemEnd;
                    jumpValHTML += jumpItem;
                }
                
                let jumpValMenu = $(jumpValHTML);
                let jumpMenus = $('.fillin.value.fulllist ul.dropdown-menu');
                jumpMenus.empty();
                jumpMenus.append(jumpValMenu);
            }
            
            /**
             * Delete all instructions in the program code
             */
            function deleteCode() {
                if (confirm("Press OK to delete ALL of your code.")) {
                    // Remove all program code lines
                    $("#program tbody tr").remove();
                    
                    // Compact the program, add a blank line
                    compactLines();
                    
                    // Renumber the blank line
                    setLineNumbers();                    
                }
            }
        </script>     
        
        <!-- Card table functions -->
        <script>
            /**
             * Deal the cards
             * 
             * @param {String|Number} hand the symbols of the cards to deal, in
             *                        order, or the number of random cards to
             *                        deal
             */
            function deal(hand) {
                // Clear off the board
                $("#cardboard").empty();
                
                // Create table rows for cards, index display, and hand display
                let cardRow = $("<tr class='cards'/>");
                let indexRow = $("<tr/>");
                let handRow = $("<tr class='handRow'/>");
                
                // Add the rows to the board
                $("#cardboard").append(indexRow);
                $("#cardboard").append(cardRow);                
                $("#cardboard").append(handRow);
                
                let deck = buildDeck(hand);                
                
                // Pick a random suit
                runState.suit = "hdcs".charAt(Math.floor(Math.random() * 4));
                runState.numCards = deck.length;
                runState.maxCard = 0;
                
                // Loop through the cards in the deck
                for (let i = 0; i < deck.length; i++) {
                    // Get the value and the symbol of the card
                    let value = deck[i]; 
                    let card = cardValString.charAt(deck[i]);
                    
                    if (value > runState.maxCard) {
                        runState.maxCard = value;
                    }
                    
                    if (deck.length < 13) {
                        let cell = $("<td ondrop='dropCard(event)'" +
                                "ondragover='allowDropInstruction(event)'>" +
                                "<img src='cards/card-" + runState.suit + card +
                                ".png' class='card cardItem' value='" + value +
                                "' draggable='true' " +
                                "ondragstart='dragCard(event)'></td>");
                        // Add the card to the board
                        cardRow.append(cell);
                    }
                    else {
                        let cell = $("<td ondrop='dropCard(event)'" +
                                "ondragover='allowDropInstruction(event)'>" +
                                "<span class='cardNum cardItem' " +
                                "value='" + value + "' draggable='true' " +
                                "ondragstart='dragCard(event)'>" +
                                value + "</span></td>");
                        
                        // Add the card to the board
                        cardRow.append(cell);
                    }
                    
                    // Add the index and hand displays
                    let index = $("<th class='cardIndex'>" + i + "</th>");
                    index.attr('width', (100/(deck.length)) + "%");
                    indexRow.append(index);
                    handRow.append("<td class='handCell'></td>");
                }             
                
                // Move the hands back to their starting locations
                moveHand(0, 0);
                moveHand(1, 1);
                
                // Add the cards to the window URL
                setURLCards(deck);
                
                // Make sure that the position values are all present
                fillPositionDropdowns();
                addDropdownHandlers(); 
            }
            
            /**
             * Build a deck from a given hand (string of chars representing card
             * values), or a random deck
             * 
             * @param {String} hand
             * @returns {Array|buildDeck.deck}
             */
            function buildDeck(hand) {
                let deck = [];
                
                if (hand === undefined || typeof (hand) === 'number') {
                    hand = hand || runState.numCards;
                    let offset = 1;
                    
                    if (hand < 9) {
                        offset = 2;
                    }
                    
                    // set the deck to (hand + 1) unshuffled cards
                    for (let i = 0; i < hand + 1; i++) {
                        deck.push(i + offset);
                    }

                    // shuffle the deck
                    for (let i = 0; i < deck.length; i++) {
                        let newPos = Math.floor(Math.random() * deck.length);

                        let card = deck[i];
                        deck[i] = deck[newPos];
                        deck[newPos] = card;                        
                    }
                    
                    // remove the last card from the deck
                    deck.pop();
                }
                else {
                    hand = hand.toLowerCase();
                    for (let i = 0; i < hand.length; i++) {
                        let card = cardValString.indexOf(hand.charAt(i));
                        
                        deck.push(card);
                    }
                }
                
                return deck;
            }
            
            /**
             * Move one of the hands to a given position
             * 
             * @param {Number} hand the hand to move (0 = left, 1 = right)
             * @param {Number} pos the position for the hand to move to on the 
             *      board
             */
            function moveHand(hand, pos) {
                // Constrain the hand to the board
                pos = Math.max(0, pos);
                pos = Math.min(runState.numCards - 1, pos);
                
                // Identify the hand to move and record its new location
                if (hand === 0) {
                    hand = "lefthand";                    
                    runState.lHand = pos;
                }
                else {                    
                    hand = "righthand";
                    runState.rHand = pos;
                }
                
                // Create html code to display hand
                let code = $("<div class='glyphicon glyphicon-hand-up handpos " + hand + "'></div>");
                
                // remove the hand from its current location
                $('.' + hand).remove();
                // Show the hand in its new location
                $($('.handCell')[pos]).append(code);
                
                return true;
            }
            
            /**
             * Shift one of the hands to the right or left
             * 
             * @param {Number} hand the hand to move (0 = left, 1 = right)
             * @param {Number} dir the direction to move (-1 = left, 1 = right)
             */
            function shiftHand(hand, dir) {
                // Identify the direction to move
                if (dir < 0) {
                    dir = -1;
                }
                else {
                    dir = 1;
                }
                
                // Calculate where to move to
                let pos = 0;
                
                // Determine which hand to move
                if (hand === 0) {
                    hand = "lefthand";
                    
                    // Determine where to move it, constrained to the board
                    pos = runState.lHand + dir;                    
                    if (pos >= 0 && pos < runState.numCards) {
                        runState.lHand = pos;
                    }
                    else {
                        alert ("You tried to move the left hand off of the table.");
                        return false;
                    }
                }
                else {
                    hand = "righthand";
                    
                    // Determine where to move it, constrained to the board
                    pos = runState.rHand + dir;                    
                    if (pos >= 0 && pos < runState.numCards) {
                        runState.rHand = pos;
                    }
                    else {
                        alert ("You tried to move the right hand off of the table.");
                        return false;
                    }
                }
                
                // Create html code to display hand
                let code = $("<div class='glyphicon glyphicon-hand-up handpos " + hand + "'></div>");
                
                // remove the hand from its current location
                $('.' + hand).remove();
                // Show the hand in its new location
                $($('.handCell')[pos]).append(code);
                return true;
            }
        </script>
        
        <!-- HML Interpreter functions -->
        <script>
            // Global singleton, keeps track of execution of HML Code
            var runState = {
                currentLine: -1,
                nextLine: -1,
                numSteps: 0,
                numCards: 8,
                runTimer: null,
                rHand: 1,
                lHand: 0,
                suit: '',
                
                /**
                 * Begin running the HML code
                 */
                go: function() {
                    // reset any current line indication
                    $('.currentLine').removeClass('currentLine');
                    $('.lastLine').removeClass('lastLine');
                    
                    // Set the starting line
                    runState.nextLine = 0;
                    
                    // Reinitialize the step count
                    numSteps = 0;
                    $('.stepCount').text(0);
                    
                    
                    // reinitialize hands
                    moveHand(0, 0);
                    moveHand(1, 1);
                    
                    // Initialize the timer
                    runState.runTimer = setTimeout(runState.doNextLine, 5);
                },
                
                /**
                 * Run the next HML instruction
                 */
                doNextLine: function() {
                    // Get all lines of code
                    let lines = $('#program tbody tr');
                    
                    // If there is a current line marked
                    if (runState.currentLine >= 0 && runState.currentLine < lines.length) {
                        // Remove the current line marker
                        $(lines[runState.currentLine]).removeClass('currentLine');
                    }
                    
                    // If the next line number is a legal line number
                    if (runState.nextLine >= 0 && runState.nextLine < lines.length) {
                        numSteps++;
                        $('.stepCount').text(numSteps);
                        
                        // Remember it as the new current line
                        runState.currentLine = runState.nextLine;
                        
                        // Get the line of code
                        let line = $(lines[runState.currentLine]);
                        
                        // Mark it as the current line
                        line.addClass('currentLine');
                        line[0].scrollIntoView();
                        
                        // Run the command
                        if (doCommand(runState, line.find('.instruction')[0])) {
                            // If the command was successful (and not a stop),
                            // prepare to run the next line
                            
                            // Calculate the time between instructions based on
                            // the value of the Run Speed Slider, scaling the
                            // value logarithmically to a range of 2000ms - 10ms
                            
                            // Get the slider value
                            let slider=$('#runSlider');
                            let time=100-slider.val();
                            
                            // Get the scaling ranges
                            let minTime = Math.log(10);
                            let maxTime = Math.log(2000);
                            let minP = slider.attr('min');
                            let maxP = slider.attr('max');
                            
                            // Calculate the scale factor
                            let scale = (maxTime - minTime) / (maxP - minP);
                            
                            // Calculate the time interval
                            time = Math.ceil(Math.exp(minTime + scale*(time-minP)));
                            
                            // Set the time to run the next instruction
                            runState.runTimer = setTimeout(runState.doNextLine, time);
                        }
                        else {
                            // If the command was not successful, or was a stop,
                            // stop running
                            stopIt();
                        }
                    }
                    else {
                        // If the next line is not a legal line, stop running
                        stopIt();
                    }
                }
            };
            
            /**
             * Prepare to run, updating the display
             */
            function runIt() {
                // Hide the run button, show the stop button
                $('.runbtn').hide();
                $('.stopbtn').show();
                
                // Disable redealing while running
                $('.redealbtn').addClass('disabled');
                
                // Begin execution
                runState.go();
            }
            
            /**
             * Stop execution, updating the display
             */
            function stopIt() {
                // Hide the stop button, show the run button
                $('.runbtn').show();
                $('.stopbtn').hide();
                
                // Reenable the redeal button
                $('.redealbtn').removeClass('disabled');
                
                // There is no longer a next line
                runState.nextLine = -1;
                
                // Stop any left over execution timer
                clearTimeout(runState.runTimer);
                
                // Display the last line executed
                $('.currentLine').addClass('lastLine');
                $('.currentLine').removeClass('currentLine');
            }
            
            /**
             * Execute one HML instruction
             * 
             * @param {runState} state the current execution state
             * @param  {jQuery} inst the instruction to run
             * @returns {Boolean} true if successful, false if execution should 
             *                    stop
             */
            function doCommand(state, inst) {
                inst = $(inst);
                
                if (inst.is('.stop')) {
                    // If this is a stop instruction, quit
                    return false;
                }
                else if (inst.is('.jump')) {
                    return doJump(state, inst);                    
                }
                else if (inst.is('.jumpif')) {
                    return doJumpIf(state, inst);
                }
                else if (inst.is('.shift')) {
                    return doShift(state, inst);
                }
                else if (inst.is('.move')) {
                    return doMove(state, inst);
                }
                else if (inst.is('.swap')) {
                    return doSwap(state);
                }
                else {
                    // If this is an unknown instruction, skip it
                    state.nextLine++;
                    return true;
                }
            }
            
            /**
             * Handle a jump instruction
             * @param {runState} state the current execution state
             * @param  {jQuery} inst the jump instruction to execute
             * @returns {Boolean} true if execution should continue, false
             *                    on error
             */
            function doJump(state, inst) {
                // If this is a jump instruction, get the jump target line number
                let lineno = getJumpTarget(inst);

                // If the line number is invalid, quit
                if (lineno < 0) {
                    return false;
                }

                // Move the instruction pointer to the next line to run
                state.nextLine = lineno - 1;

                // And allow execution to continue
                return true;
            }
            
            /**
             * Handle a jump-if instruction
             * @param {runState} state the current execution state
             * @param  {jQuery} inst the jump instruction to execute
             * @returns {Boolean} true if execution should continue, false
             *                    on error
             */
            function doJumpIf(state, inst) {
                // If this is a jump-if instruction, get the jump target line
                let lineno = getJumpTarget(inst);

                // If the line number is invalid, quit
                if (lineno < 0) {
                    return false;
                }

                // Assume we won't jump, what line should we go to?
                let nextLine = state.nextLine + 1;
                let shouldJump = false;

                // Determine what values to compare
                let values = getCardOrPosValues(inst, state);
                if (values === null) {
                    return false;
                }
                
                // Determine the comparison to perform
                let comp = getComparison(inst);
                if (comp === null) {
                    return false;
                }
                // Perform the comparison to determine if we should jump
                switch (comp) {
                    case "=":
                        shouldJump = values[0] === values[1];
                        break;
                    case "!=":
                        shouldJump = values[0] !== values[1];
                        break;
                    case "<":
                        shouldJump = values[0] < values[1];
                        break;
                    case ">":
                        shouldJump = values[0] > values[1];
                        break;
                    case ">=":
                        shouldJump = values[0] >= values[1];
                        break;
                    case "<=":
                        shouldJump = values[0] <= values[1];
                        break;
                }
                
                // If we should jump, calculate the new line
                if (shouldJump) {
                    nextLine = lineno - 1;
                }

                // Move the instruction pointer to the next line to run
                state.nextLine = nextLine;

                // And allow execution to continue
                return true;
            }
            
            /**
             * Determine the target line number for a jump or jump-if
             *  instruction
             *  
             * @param {jQuery} inst the jump instruction
             * @returns {Number} the target line number of the jump, -1 if the
             *                   instruction has an invalid target
             */
            function getJumpTarget(inst) {
                // Get the instructions target linenumber
                let lineno = inst.find('.linenum .dropdown-text').text();
                lineno = parseInt(lineno);
                
                // If the target is invalid
                if (isNaN(lineno)) {
                    // Alert the user and quit
                    alert("You need to set the line to jump TO!");
                    return -1;
                }
                
                // Otherwise, return the valid jump target
                return lineno;
            }
            
            /**
             * Get the values to compare in an instruction
             * 
             * @param {jQuery} inst the jump instruction
             * @param {runState} state the current execution state
             * @returns {Number[]} the values in the conditional, null if invalid
             */
            function getCardOrPosValues(inst, state) {
                let values = [];
                let invalid = false;
               
                // Find each value in the instruction
                inst.find('.value .dropdown-text').each(function() {
                    if (!invalid) {
                        // Get the text for this value
                        let val = $(this).text().trim();

                        // Determine the text for the value
                        switch (val) {
                            case ("Right Hand Card"):
                                // Use the value of the card the right hand is touching
                                val = $($('.cards .cardItem')[state.rHand]).attr('value');
                                values.push(parseInt(val));
                                break;
                            case ("Left Hand Card"):
                                // Use the value of the card the left hand is touching
                                val = $($('.cards .cardItem')[state.lHand]).attr('value');
                                values.push(parseInt(val));
                                break;
                            case ("Right Hand Position"):
                                // Use the value of the position of the right hand
                                values.push(state.rHand);
                                break;
                            case ("Left Hand Position"):
                                // Use the value of the position of the left hand
                                values.push(state.lHand);
                                break;
                            case ("Min Position"):
                                // Use the minimum position
                                values.push(0);
                                break;                                
                            case ("Max Position"):
                                // Use the minimum position
                                values.push(state.numCards - 1);
                                break;
                            default:
                                // Use a literal value
                                val = parseInt(val);
                                
                                // If there is no literal value, there was an error
                                if (isNaN(val)) {
                                    alert("You need to set a value to compare.");
                                    invalid = true;
                                }
                                
                                values.push(val);
                        }
                    }
               });
               
               // If any invalid value was found, ignore all values
               if (invalid) {
                   return null;
               }
               
               // Otherwise, return the valid values
               return values;
            }
            
            /**
             * Get the comparison in an instruction
             * 
             * @param {jQuery} inst the jump-if instruction
             * @returns {String} the comparison character, null if invalid
             */
            function getComparison(inst) {
                let comp = inst.find('.comparison .dropdown-text').text().trim();
                
                switch (comp) {
                    case "=":
                        return "=";
                    case "<":
                        return "<";
                    case ">":
                        return ">";
                    case "\u2264":
                        return "<=";
                    case "\u2265":
                        return ">=";
                    case "\u2260":
                        return "!=";    
                    default:
                        alert("You need to set the comparison operator.");
                        return null;
                }
            }
            
            /**
             * Handle a shift instruction
             * 
             * @param {runState} state the current execution state
             * @param  {jQuery} inst the shift instruction to execute
             * @returns {Boolean} true if the shift was successful, false if
             *                    execution should quit.
             */
            function doShift(state, inst) {
                let hand = getHand(inst, "shift");
                if (hand === -1) {
                    return false;
                }
                
                let dir = getDir(inst);
                if (dir === 0) {
                    return false;
                }
                
                // Move the instruction pointer to the next line to run
                state.nextLine++;
                return shiftHand(hand, dir);
            }
            
            /**
             * Handle a move instruction
             * 
             * @param {runState} state the current execution state
             * @param {jQuery} inst the shift instruction to execute
             * @returns {Boolean} true if the shift was successful, false if
             *                    execution should quit.
             */
            function doMove(state, inst) {
                let hand = getHand(inst, "move");
                if (hand === -1) {
                    return false;
                }
                
                let pos = getPosition(inst, state);
                if (pos < 0) {
                    return false;
                }
                
                // Move the instruction pointer to the next line to run
                state.nextLine++;
                return moveHand(hand, pos);
            }
            
            /**
             * Determine the hand an instruction refers to
             * 
             * @param {jQuery} inst the shift/move instruction
             * @param {String} command "shift" or "move" for error display
             * @returns {Number} 0 = left hand, 1 = right hand, -1 = error
             */
            function getHand(inst, command) {
                // Get the hand text
                let hand = inst.find('.hand .dropdown-text').text().trim();
                
                // If a valid hand was set, return the appropriate value
                if (hand === "Right Hand") {
                    return 1;
                }
                else if (hand === "Left Hand") {
                    return 0;
                }
                
                // Otherwise, show an error and return an error code
                alert("You need to set which hand to " + command + ".");
                return -1;
            }
            
            /**
             * Determine the direction to shift the hand
             * 
             * @param {jQuery} inst the shift instruction
             * @returns {Number} -1 = left, 1 = right, 0 = error
             */
            function getDir(inst) {
                // Get the direction text
                let dir = inst.find('.dir .dropdown-text').text().trim();
                
                // If a valid direction was set, return the appropriate value
                if (dir === "Right") {
                    return 1;
                }
                else if (dir === "Left") {
                    return -1;
                }

                // Otherwise, show an error and return an error code
                alert("You need to set a direction to to shift the hand.");
                return 0;
            }
            
            
            /**
             * Determine the location to move the hand to
             * 
             * @param {jQuery} inst the move instruction
             * @param {runState} state the current execution state
             * 
             * @returns {Number} -1 = error, 0..7, the new location
             */
            function getPosition(inst, state) {
                // Get the direction text
                let pos = inst.find('.pos .dropdown-text').text().trim();
                let posNum = parseInt(pos);
                
                // If a valid direction was set, return the appropriate value
                if (pos === "Right Hand Position") {
                    return state.rHand;
                }
                else if (pos === "Left Hand Position") {
                    return state.lHand;
                }
                else if (pos === "Min Position") {
                    return 0;
                }
                else if (pos === "Max Position") {
                    return state.numCards - 1;
                }
                else if (!isNaN(posNum)) {
                    return posNum;
                }

                // Otherwise, show an error and return an error code
                alert("You need to set which card position to move the hand to.");
                return -1;
            }
            
            
            /**
             * Handle a swap instruction
             * 
             * @param {runState} state the current execution state
             * @returns {Boolean} true if the swap was successful, false if
             *                    execution should quit.
             */
            function doSwap(state) {
                // Don't swap if both hands are in the same position
                if (state.lHand === state.rHand) {
                    state.nextLine++;
                    return true;
                }
                
                // Get the card cell and its value for the left hand
                let lhTD = $($('.cards td')[state.lHand]);
                let lhItem = lhTD.find('.cardItem');
                
                // Get the card cell and its value for the right hand
                let rhTD = $($('.cards td')[state.rHand]);
                let rhItem = rhTD.find('.cardItem');
                                                
                // Put the cards in their new home
                lhTD.append(rhItem);
                rhTD.append(lhItem);
                
                state.nextLine++;
                return true;
                    
            }
            </script>
        
        <!-- Clipboard interaction -->
        <script>
            /**
             * Copy all of the program instructions to the clipboard
             */
            function copyInstructions() {
                let code = "";
                let line = 1;
                
                // Get each program instruction
                $('#program .instruction').each(function() {
                    // Make a temporary copy of the instruction
                    let c = $(this).clone();
                    
                    // Remove the dropdowns from the copy
                    c.find('ul').remove();
                    
                    // Add the line number and instruction text to the output code
                    code += line + '\t';
                    code += (c.contents().text().trim().replace(/\s+/g, ' '));
                    code += '\n';
                    
                    // increment the line number
                    line++;
                });
                
                // Create a temporary text area to copy the code from
                var $temp = $("<textarea>");
                $("body").append($temp);
                
                // Add the code to the text area and select it
                $temp.val(code).select();
                
                // Copy the code to the clipboard
                document.execCommand("copy");
                
                // Remove the temporary text area
                $temp.remove();
            }
        </script>
        <script>
            /**
             * Update the page url to include the current program code
             */
            function setURLCode() {
                let code="";
                
                // Convert all of the program instructions into code
                $('#program .instruction').each(function() {
                    code += instToCode($(this));
                });
                
                // Add the code to the url
                var url = new URL(window.location);
                url.searchParams.set('code', code);
                
                // Set the window url
                window.history.replaceState(null, document.title, url);
            }
            
            /**
             * Set the window url to include the current card deck
             * 
             * @param {Array|buildDeck.deck} deck the deck of cards to add to
             *         the url
             */
            function setURLCards(deck) {
                let cards = '';
                
                deck = deck || makeDeckArray();
                
                // Build up a string of card symbols from the deck
                for (let i = 0; i < deck.length; i++) {
                    cards += cardValString.charAt(deck[i]);
                }
                
                // Add the code to the url
                var url = new URL(window.location);
                url.searchParams.set('cards', cards);
                
                // Set the window url
                window.history.replaceState(null, document.title, url);
            }
            
            /**
             * Set the window url to include the current run speed.
             * 
             * @param {int|speed} current step speed
             */
            function setURLSpeed(runSpeed) {
                let params = new URLSearchParams(window.location.search);
                if (params.has('speed')) {
                    // Add the code to the url
                    var url = new URL(window.location);
                    url.searchParams.set('speed', runSpeed);

                    // Set the window url
                    window.history.replaceState(null, document.title, url);
                }
            }
            
            /**
             * Build an array of card values from the card board
             * 
             * @returns {Array|Number}
             */
            function makeDeckArray() {
                let deck = [];
                
                // Get all of the cards on the board
                let cards = $('#cardboard .cards td .carditem');
                
                // Loop through each of the cards
                cards.each(function() {
                    // Add the card value to the deck array
                    deck.push(parseInt($(this).attr('value')));
                });
                
                // Return the array of card values
                return deck;
            }
                        
            /**
             * Convert an instruction block into compressed code
             * 
             * @param {jQuery} inst the instruction block to convert to code
             * @returns {String} the compressed code version of the instruction
             */
            function instToCode(inst) {
                let code = "";
                
                if (inst.is('.stop')) {
                    code = 'X';
                }
                else if (inst.is('.jump')) {
                    code = 'J';
                    code += jumpTargetCode(inst.find('.linenum .dropdown-text').text().trim());
                }
                else if (inst.is('.jumpif')) {
                    let vals = inst.find('.value .dropdown-text');
                    
                    code = 'I';                    
                    code += jumpTargetCode(inst.find('.linenum .dropdown-text').text().trim());
                    code += valCode($(vals[0]).text().trim());
                    code += compCode(inst.find('.comparison .dropdown-text').text().trim());
                    code += valCode($(vals[1]).text().trim());
                }
                else if (inst.is('.shift')) {
                    code = 'S';                                                   
                    code += handCode(inst.find('.hand .dropdown-text').text().trim());
                    code += dirCode(inst.find('.dir .dropdown-text').text().trim());
                }
                else if (inst.is('.move')) {
                    code = 'M';
                    code += handCode(inst.find('.hand .dropdown-text').text().trim());
                    code += posCode(inst.find('.pos .dropdown-text').text().trim());
                }
                else if (inst.is('.swap')) {
                    code = 'W';
                }
                
                return code;
            }
            
            /**
             * Convert a hand to its code version
             * 
             * @param {String} hand
             * @returns {String}
             */
            function handCode(hand) {
                if (hand === 'Right Hand') {
                    return 'r';
                }
                else if (hand === 'Left Hand') {
                    return 'l';
                }                    
                else {
                    return 'x';
                }
            }
            
            /**
             * Convert a direction to its code version
             * 
             * @param {String} dir
             * @returns {String}
             */
            function dirCode(dir) {
                if (dir === 'Right') {
                    return 'r';
                }
                else if (dir === 'Left') {
                    return 'l';
                }                    
                else {
                    return 'x';
                }
            }
            
            /**
             * Convert a position to its code version
             * @param {String} pos
             * @returns {Number|String}
             */
            function posCode(pos) {
                if (pos === 'Right Hand Position') {
                    return 'r';
                }
                else if (pos === 'Left Hand Position') {
                    return 'l';
                }  
                else if (pos === 'Min Position') {
                    return 'i';
                }
                else if (pos === 'Max Position') {
                    return 'a';
                }
                else {
                    // Use a literal value
                    pos = parseInt(pos);

                    // If there is no literal value, there was an error
                    if (isNaN(pos)) {
                        return 'x';
                    }
                    else {
                        return pos;
                    }
                }
            }
            
            /**
             * Convert a jump target to a code version
             * 
             * @param {String} target
             * @returns {jumpTargetCode.lineno|String}
             */
            function jumpTargetCode(target) {
                let lineno = parseInt(target);
                if (isNaN(lineno)) {
                    return "x";
                }
                else {
                    return lineno;
                }
            }
            
            /**
             * Convert a comparison value to its code version
             * 
             * @param {String} val
             * @returns {Number|String}
             */
            function valCode(val) {
                switch (val) {
                    case ("Right Hand Card"):
                        return 'R';
                    case ("Left Hand Card"):
                        return 'L';
                    case ("Right Hand Position"):
                        return 'r';
                    case ("Left Hand Position"):
                        return 'l';
                    case ("Min Position"):
                        return 'i';
                    case ("Max Position"):
                        return 'a';
                    default:
                        // Use a literal value
                        val = parseInt(val);

                        // If there is no literal value, there was an error
                        if (isNaN(val)) {
                            return 'x';
                        }
                        else {
                            return val;
                        }
                }
            }
            
            /**
             * Convert a comparison operator to a letter code
             * 
             * @param {String} comp
             * @returns {String}
             */
            function compCode(comp) {
                switch (comp) {
                    case "=":
                        return "e";
                    case "<":
                        return "l";
                    case ">":
                        return "g";
                    case "\u2264":
                        return "L";
                    case "\u2265":
                        return "G";
                    case "\u2260":
                        return "n";    
                    default:
                        return "x";
                }
            }
            
            
            /**
             * Build a program from compressed url
             * 
             * @param {String} code the compressed code to turn into instructions
             */
            function buildProgram (code) {                
                while (code.length > 0) {
                    code = parseInstruction(code);
                }
            }
            
            /**
             * Parse and remove the first instruction from program code
             * 
             * @param {String} code the compressed program code
             * @returns {String} the program code with the first instruction 
             *                   removed
             */
            function parseInstruction(code) {
                let end = 0;
                let target = "";
                let hand = "";
                
                switch (code.charAt(0)) {
                    case 'X':
                        // Stop Instruction
                        end++;
                        addInstruction($('.palette .stop').clone());
                        break;
                        
                    case 'J':
                        // Jump Instruction
                        end++;                        
                        target = jumpTarget(code.substr(end));
                        end += target.length;
                        
                        addInstruction(buildJump(target));
                        break;
                        
                    case 'I':
                        // Jump-if instruction
                        end++;
                        
                        target = jumpTarget(code.substr(end));
                        end += target.length;
                        
                        let val1 = getValue(code.substr(end));
                        end += val1.length;
                        
                        let comp = comparisonSymbol(code.charAt(end));
                        end++;
                        
                        let val2 = getValue(code.substr(end));
                        end += val2.length;
                        
                        addInstruction(buildJumpIf(target, val1, comp, val2));
                        break;
                        
                    case 'S':
                        // Shift instruction
                        end++;
                        
                        hand = getHandCode(code.substr(end));
                        end += hand.length;
                        
                        let dir = getDirectionCode(code.substr(end));
                        end += dir.length;
                        
                        addInstruction(buildShift(hand, dir));
                        break;
                        
                    case 'M':
                        // Move instruction
                        end++;
                        
                        hand = getHandCode(code.substr(end));
                        end += hand.length;
                        
                        let pos = getPosCode(code.substr(end));
                        end += pos.length;
                        
                        addInstruction(buildMove(hand, pos));
                        break;
                        
                    case 'W':
                        // Swap instruction
                        end++;
                        addInstruction($('.palette .swap').clone());
                        break;
                        
                    default:
                        // This was an invalid instruction, search for the next
                        // valid instruction
                        for (end++; end < code.length; end++) {
                            if ('XJISMW'.includes(code.charAt(end))) {
                                break;
                            }
                        }
                }
                
                // Return the code with this instruction cut off
                return code.substr(end);
            }
            
            /**
             * Add an instruction to the end of the program
             * 
             * @param {jQuery} inst the instruction block to add
             */
            function addInstruction(inst) {
                let programBody = $('#program tbody');
                let newRow = $(instRow);
                
                newRow.find('.instructioncell').append(inst);
                
                programBody.append(newRow);                
            }
            
            /**
             * Get a target line number at the beginning of compressed code
             * 
             * @param {String} code
             * @returns {String} the target line number for the jump or 'x' if 
             *                   not set
             */
            function jumpTarget(code) {
                let target = parseInt(code);
                
                if (isNaN(target)) {
                    return 'x';
                }
                else {
                    return '' + target;
                }
            }
            
            /**
             * Get a comparison value from the beginning of compressed code
             * @param {String} code
             * @returns {String} the comparison value, 'x' if not set
             */        
            function getValue(code) {
                let c = code.charAt(0);

                switch (c) {
                    case 'x':
                    case 'R':
                    case 'r':
                    case 'L':
                    case 'l':
                    case 'i':
                    case 'a':
                        // A preset value code
                        return c;
                        
                    default:
                        // Use a literal value
                        let val = parseInt(code);

                        // If there is no literal value, there was an error
                        if (isNaN(val)) {
                            return 'x';
                        }
                        else {
                            // If the value is a number, return it as a String
                            return '' + val;
                        }
                }
            }
            
            /**
             * Build a jump instruction block given a target line
             * 
             * @param {String} target the jump target line, 'x' if not set
             * @returns {jQuery} the jump instruction block
             */
            function buildJump(target) {
                let inst = $('.palette .jump').clone();
                
                if (target !== 'x') {
                    inst.find('.linenum .dropdown-text').html(target +
                            caret);
                }
                
                return inst;
            }
            
            /**
             * Build a jump-if instruction block
             * 
             * @param {String} target
             * @param {String} val1
             * @param {String} comp
             * @param {String} val2
             * @returns {jQuery} the jump-if instruction block
             */
            function buildJumpIf(target, val1, comp, val2) {
                let inst = $('.palette .jumpif').clone();
                
                if (target !== 'x') {
                    inst.find('.linenum .dropdown-text').html(target + caret);
                }
                
                let vals = inst.find('.value .dropdown-text');
                
                if (val1 !== 'x') {
                    $(vals[0]).html(expandValue(val1) + caret);
                }
                if (val2 !== 'x') {
                    $(vals[1]).html(expandValue(val2) + caret);
                }
                
                if (comp !== 'x') {
                    inst.find('.comparison .dropdown-text').html(comp + caret);
                }
                
                return inst;
            }
            
            /**
             * Build a shift instruction block
             * 
             * @param {String} hand the hand code
             * @param {String} dir the direction code
             * @returns {jQuery} the shift instruction block
             */
            function buildShift(hand, dir) {
                let inst = $('.palette .shift').clone();
                
                if (hand !== 'x') {
                    inst.find('.hand .dropdown-text').html(expandHand(hand) + caret);
                }
                
                if (dir !== 'x') {
                    inst.find('.dir .dropdown-text').html(expandDir(dir) + caret);
                }
                
                return inst;
            }
            
            /**
             * Build a move instruction block
             * 
             * @param {String} hand the hand code
             * @param {String} pos the direction code
             * @returns {jQuery} the shift instruction block
             */
            function buildMove(hand, pos) {
                let inst = $('.palette .move').clone();
                
                if (hand !== 'x') {
                    inst.find('.hand .dropdown-text').html(expandHand(hand) + caret);
                }
                
                if (pos !== 'x') {
                    inst.find('.pos .dropdown-text').html(expandPos(pos) + caret);
                }
                
                return inst;
            }
            
            /**
             * Expand a compressed comparison value to a full string
             * 
             * @param {String} val
             * @returns {String}
             */
            function expandValue(val) {
                switch (val) {
                    case 'R':
                        return "Right Hand Card";
                    case 'r':
                        return "Right Hand Position";
                    case 'L':
                        return "Left Hand Card";
                    case 'l':
                        return "Left Hand Position"; 
                    case 'i':
                        return "Min Position";
                    case 'a':
                        return "Max Position";   
                    default:
                        return val;
                }
            }
            
            /**
             * Convert a comparison code to the unicode symbol
             *  
             * @param {String} comp
             * @returns {String}
             */
            function comparisonSymbol(comp) {
                switch (comp) {
                    case "e":
                        return "=";
                    case "l":
                        return "&lt;";
                    case "g":
                        return "&gt;";
                    case "L":
                        return "\u2264";
                    case "G":
                        return "\u2265";
                    case "n":
                        return "\u2260";    
                    default:
                        return "x";
                }
            }
            
            /**
             * Get the hand code from the beginning of compressed code
             * 
             * @param {String} code
             * @returns {String} the hand code or 'x' if not set
             */
            function getHandCode(code) {
                let c = code.charAt(0);

                switch (c) {
                    case 'x':
                    case 'r':
                    case 'l':
                        return c;
                    default:
                        return 'x';
                }
            }
            
            /**
             * Get the direction code from the beginning of compressed code
             * 
             * @param {String} code
             * @returns {String} the direction code or 'x' if not set
             */
            function getDirectionCode(code) {
                let c = code.charAt(0);

                switch (c) {
                    case 'x':
                    case 'r':
                    case 'l':
                        return c;
                    default:
                        return 'x';
                }
            }
            
            /**
             * Get the text for a hand symbol
             * 
             * @param {String} hand
             * @returns {String}
             */
            function expandHand(hand) {
                switch (hand) {
                    case 'r':
                        return 'Right Hand';
                    case 'l':
                        return 'Left Hand';
                    default:
                        return hand;
                }
            }
            
            /**
             * Get a hand position from the beginning of compressed code
             * @param {String} code
             * @returns {String} the position code/value, 'x' if not set
             */        
            function getPosCode(code) {
                let c = code.charAt(0);

                switch (c) {
                    case 'r':
                    case 'l':
                    case 'i':
                    case 'a':
                    case 'x':
                        // A preset value code
                        return c;
                        
                    default:
                        // Use a literal value
                        let val = parseInt(code);

                        // If there is no literal value, there was an error
                        if (isNaN(val)) {
                            return 'x';
                        }
                        else {
                            // If the value is a number, return it as a String
                            return '' + val;
                        }
                }
            }
            
            /**
             * Get the text for a direction symbol
             * 
             * @param {String} dir
             * @returns {String}
             */
            function expandDir(dir) {
                switch (dir) {
                    case 'r':
                        return 'Right';
                    case 'l':
                        return 'Left';
                    default:
                        return dir;
                }
            }
            
            /**
             * Get the position text for a position symbol
             * 
             * @param {String} pos
             * @returns {String}
             */
            function expandPos(pos) {
                switch (pos) {
                    case 'r':
                        return 'Right Hand Position';
                    case 'l':
                        return 'Left Hand Position';
                    case 'i':
                        return 'Min Position';
                    case 'a':
                        return 'Max Position';
                    default:
                        return pos;
                }
            }
        </script>    
    </body>
</html>
